var e,t;e=global,t=function(){return function(e){var t={};function n(s){if(t[s])return t[s].exports;var a=t[s]={i:s,l:!1,exports:{}};return e[s].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(s,a,function(t){return e[t]}.bind(null,a));return s},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);class s{}class a extends s{}class i extends s{}class r{constructor(e,t,n){this.commandType=e,this.clientID=t,this.teamID=n}}class l{constructor(e,t){this._isObserver=!1,this.clientID=e,this.teamID=t}get isObserver(){return this._isObserver}set isObserver(e){this._isObserver=e}}class o extends l{constructor(e,t,n){super(e,t),this._commandsBuffer=[],this._local=n,n.clientID=e,n.onCommandRecieved.push(this.recieveCommand.bind(this))}createScenario(e,t){}sendDataUpdate(e){}grabCommands(e,t){let n=this._commandsBuffer;return this._commandsBuffer=[],n}recieveCommand(e){e.clientID=this.clientID,e.teamID=this.teamID,this._commandsBuffer.push(e)}}class c extends l{constructor(e,t,n){super(e,t),this._ai=n}createScenario(e,t){this._data=e,this._ai.create(this.clientID,this.teamID,t)}sendDataUpdate(e){this._data=e}grabCommands(e,t){return e.setClient(this.clientID),e.setTeam(this.teamID),this._ai.update(this._data,e,t)}}class h{loadScenario(e){this.scenario=e,this.scenario.ready&&this.scenario.create()}}class d extends h{constructor(){super(...arguments),this._ticks=0,this._maxTicks=1e3,this._delta=1/60}run(){if(!this.scenario.ready)throw new Error("Cannot run server as scenario is not ready");for(this.scenario.created||this.scenario.create(),console.log("Running scenario:"),console.log("for",this._maxTicks,"updates"),console.log("with a",this._delta,"s timestep");!this.scenario.ended&&this._ticks<this._maxTicks;)this.scenario.update(this._delta),this._ticks++;return console.log("Simulation completed after",this._ticks,"updates (",this._maxTicks*this._delta,"seconds simulated)"),console.log("Game over state was "+(this.scenario.ended?"":"not ")+"found"),!0}}class u{constructor(e,t,n){this._created=!1,this._gameModel=e,this._data=t,this._clients=n}get ended(){return this._ended}get ready(){return 0===this._clients.remainingSlots}get created(){return this._created}get clients(){return this._clients}get gameModel(){return this._gameModel}get data(){return this._data}create(){this.clients.createScenario(this._data,this._gameModel),this._created=!0}load(e){this._data.load(e)}getSaveData(){return this._data.save()}addClient(e){return this._clients.addClient(e)}addAITeam(e){this._clients.addClient(new c(this._clients.nextClient,this._clients.nextTeam,e))}addLocalClient(e){return this._clients.addClient(new o(this._clients.nextClient,this._clients.nextTeam,e))}runHeadless(){let e=new d;return e.loadScenario(this),!!e.run()}}class m extends u{update(){this.ended||(this.gameModel.applyCommands(this.data,this.clients.getCommandsOfClient(this.data.getCurrentPlayer(),1)),this.gameModel.goalTest(this.data)&&(this._ended=!0),this.data.moveToNextPlayer(),this.clients.sendDataUpdate(this.data))}}class g extends u{update(e){if(!this.ended){let t=this.clients.getCommands(e);this.gameModel.applyCommands(this.data,t,e),this.gameModel.goalTest(this.data)&&(this._ended=!0),this.clients.sendDataUpdate(this.data)}}}class f{constructor(e,t){this._clients=[],this._clientsCount=0,this._clients=new Array(e),this.commandFactory=t}get clientsCount(){return this._clientsCount}get maxClients(){return this._clients.length}get remainingSlots(){return this._clients.length-this._clientsCount}get nextClient(){let e=0;for(let t=0;t<this._clients.length;t++)this._clients[t]&&this._clients[t].clientID===e&&e++;return e}get nextTeam(){let e=0;for(let t=0;t<this._clients.length;t++)this._clients[t]&&this._clients[t].teamID===e&&e++;return e}addClient(e){for(let t=0;t<this._clientsCount;t++)if(this._clients[t].clientID===e.clientID)return!1;return this._clientsCount!==this._clients.length&&(this._clients[this._clientsCount]=e,this._clientsCount++,!0)}setObserver(e,t){this._clients[e].isObserver=t}createScenario(e,t){for(let n=0,s=this._clientsCount;n<s;n++)this._clients[n].createScenario(e,t)}sendDataUpdate(e,t){for(let t=0,n=this._clientsCount;t<n;t++)this._clients[t].sendDataUpdate(e)}getCommands(e){let t=[];for(let n=0,s=this._clientsCount;n<s;n++)this._clients[n].isObserver||(t=t.concat(this._clients[n].grabCommands(this.commandFactory,e)));return t}getCommandsOfClient(e,t){if(!this._clients[e].isObserver)return this._clients[e].grabCommands(this.commandFactory,t)}}var p,_,v,y;!function(e){e[e.Wolf=0]="Wolf",e[e.Sheep=1]="Sheep",e[e.Cabbage=2]="Cabbage"}(p||(p={})),function(e){e[e.MoveWolf=0]="MoveWolf",e[e.MoveCabbage=1]="MoveCabbage",e[e.MoveSheep=2]="MoveSheep",e[e.MoveFarmer=3]="MoveFarmer"}(_||(_={}));class k{load(e){this.leftBank=e.leftBank.slice(),this.rightBank=e.rightBank.slice(),this.farmerOnLeftBank=e.farmerOnLeftBank}cloneFrom(e){this.leftBank=e.leftBank.slice(),this.rightBank=e.rightBank.slice(),this.farmerOnLeftBank=e.farmerOnLeftBank}clients(){return 1}save(){return{leftBank:this.leftBank,rightBank:this.rightBank,farmerOnLeftBank:this.farmerOnLeftBank}}equals(e){if(this.leftBank.length!==e.leftBank.length)return!1;if(this.farmerOnLeftBank!==e.farmerOnLeftBank)return!1;for(let t=0,n=this.leftBank.length;t<n;t++){let n=!1;for(let s=0,a=e.leftBank.length;s<a;s++)if(this.leftBank[t]===e.leftBank[s]){n=!0;break}if(!n)return!1}return!0}getCurrentPlayer(){return 0}moveToNextPlayer(){}}class b extends a{stateActionMapping(e){if(this._checkIfFailureState(e))return[];let t=e.farmerOnLeftBank?e.leftBank:e.rightBank,n=new Array(t.length+1);n[n.length-1]=_.MoveFarmer;for(let e=0,s=t.length;e<s;e++)t[e]===p.Cabbage?n[e]=_.MoveCabbage:t[e]===p.Sheep?n[e]=_.MoveSheep:t[e]===p.Wolf&&(n[e]=_.MoveWolf);return n}applyCommands(e,t){if(!t)throw new Error("Command submitted was null");if(t instanceof Array)throw new Error("Must submit a single command as an action (not an array)");if(t.commandType===_.MoveFarmer)e.leftBank=e.leftBank,e.rightBank=e.rightBank,e.farmerOnLeftBank=!e.farmerOnLeftBank;else{let n;t.commandType===_.MoveCabbage?n=p.Cabbage:t.commandType===_.MoveSheep?n=p.Sheep:t.commandType===_.MoveWolf&&(n=p.Wolf);let s=[],a=[];for(let t=0,a=e.leftBank.length;t<a;t++)e.leftBank[t]!==n&&s.push(e.leftBank[t]);for(let t=0,s=e.rightBank.length;t<s;t++)e.rightBank[t]!==n&&a.push(e.rightBank[t]);e.farmerOnLeftBank?a.push(n):s.push(n),e.leftBank=s,e.rightBank=a,e.farmerOnLeftBank=!e.farmerOnLeftBank}}goalTest(e){return!!this._checkIfFailureState(e)||0===e.leftBank.length}heuristic(e){return 1e3*e.leftBank.length}_checkIfFailureState(e){if(e.farmerOnLeftBank){if(-1!==e.rightBank.indexOf(p.Wolf)&&-1!==e.rightBank.indexOf(p.Sheep)||-1!==e.rightBank.indexOf(p.Cabbage)&&-1!==e.rightBank.indexOf(p.Sheep))return!0}else if(-1!==e.leftBank.indexOf(p.Wolf)&&-1!==e.leftBank.indexOf(p.Sheep)||-1!==e.leftBank.indexOf(p.Cabbage)&&-1!==e.leftBank.indexOf(p.Sheep))return!0;return!1}}class C{setClient(e){}setTeam(e){}getCommandList(){return[_.MoveCabbage,_.MoveFarmer,_.MoveWolf,_.MoveSheep]}getCommand(e){return new r(e,0,0)}}class M extends m{constructor(){let e=new k;e.load({leftBank:[p.Sheep,p.Wolf,p.Cabbage],rightBank:[],farmerOnLeftBank:!0}),super(new b,e,new f(1,new C))}}class B{constructor(){this.inUse=!1}}!function(e){e[e.Floor=0]="Floor",e[e.Void=1]="Void"}(v||(v={}));class w{cloneFrom(e){}clients(){return this.teams.length}load(e){if(!e.map){e.map=new Array(20);for(let t=0;t<e.map.length;t++){e.map[t]=new Array(20);for(let n=0;n<e.map[t].length;n++)e.map[t][n]=0}}if(this.teams=e.teams,this.teams.forEach((e,t)=>{if(e.isPlaying&&0===e.currentAgents)throw new Error("Save Data Error: A team with 0 agents must have an isPlaying value of false");if(e.killCount.length!==this.teams.length)throw new Error("Save Data Error: Incorrect length of kill count array ("+e.killCount.length+") for team "+t+" it should be length "+this.teams.length)}),this.agents=e.agents,this.teams.length!=this.agents.length)throw new Error("Save Data Error: Mismatch between number of teams ("+this.teams.length+") and number of arrays of agents ("+this.agents.length+"). The must be one array of agents per team.");this.agentsLength=e.agents.map(e=>e.length),this.teams.forEach((e,t)=>{if(e.currentAgents!==this.agentsLength[t])throw new Error("Save Data Error: Mismatch between current agents in team and number of agents listed for team with index"+t)}),this.map=new Array(e.map.length);for(let t=0,n=this.map.length;t<n;t++){this.map[t]=new Array(e.map[t].length);for(let n=0,s=this.map.length;n<s;n++)this.map[t][n]=e.map[t][n]}this.projectiles=new Array(100);for(let e=0;e<this.projectiles.length;e++)this.projectiles[e]=new B;this.projectilesLength=0}save(){let e=new Array(this.teams.length);for(let t=0,n=this.teams.length;t<n;t++)e[t]=this.teams[t];let t=new Array(this.map.length);for(let e=0,n=this.map.length;e<n;e++){t[e]=new Array(this.map[e].length);for(let n=0,s=this.map.length;n<s;n++)t[e][n]=this.map[e][n]}let n=new Array(this.teams.length);for(let e=0;e<this.agents.length;e++){n[e]=new Array(this.agents[e].length);for(let t=0;t<this.agents[e].length;t++)n[e][t]=this.agents[e][t]}return{teams:e,map:t,agents:n}}}!function(e){e[e.AgentMoveNorth=0]="AgentMoveNorth",e[e.AgentMoveSouth=1]="AgentMoveSouth",e[e.AgentMoveEast=2]="AgentMoveEast",e[e.AgentMoveWest=3]="AgentMoveWest",e[e.SpawnProjectile=4]="SpawnProjectile"}(y||(y={}));class x extends i{constructor(){super(),this._allActions=[];for(let e in y)isNaN(Number(e))||this._allActions.push(parseInt(e))}stateActionMapping(e){return this._allActions}applyCommands(e,t,n){for(let s=0,a=t.length;s<a;s++)if(t[s]){e.teams[t[s].teamID].movesMade++;let a=e.agents[t[s].teamID][t[s].agentID];if(!a)throw new Error("Command returned for agent that does not exist. Team "+t[s].teamID+", agent: "+t[s].agentID);this._agentActions(t[s],t[s].teamID,t[s].agentID,n,a,e)}this._doStateUpdate(e,n)}_agentActions(e,t,n,s,a,i){if(e.commandType===y.AgentMoveNorth)a.velocityY=Math.max(a.velocityY-a.speed,-a.speed);else if(e.commandType===y.AgentMoveSouth)a.velocityY=Math.min(a.velocityY+a.speed,a.speed);else if(e.commandType===y.AgentMoveEast)a.velocityX=Math.min(a.velocityX+a.speed,a.speed);else if(e.commandType===y.AgentMoveWest)a.velocityX=Math.max(a.velocityX-a.speed,-a.speed);else if(e.commandType===y.SpawnProjectile)if(e.arg instanceof B)e.arg.inUse=!0;else if(i.projectilesLength<i.projectiles.length-1){let e=5*Math.random()-2.5,n=5*Math.random()-2.5,s=i.projectiles[i.projectilesLength];i.projectilesLength++,s.x=a.x,s.y=a.y,s.velocityX=a.velocityX+e,s.velocityY=a.velocityY+n,s.damage=1,s.team=t,s.timeToLive=5,s.collideRadius=.1,s.inUse=!0}}_doStateUpdate(e,t){for(let n=0,s=e.agents.length;n<s;n++)for(let s=0,a=e.agentsLength[n];s<a;s++)this._updateAgent(n,s,t,e.agents[n][s],e);for(let t=0;t<e.teams.length;t++)0===e.teams[t].currentAgents&&(e.teams[t].isPlaying=!1);let n;for(let s=0;s<e.projectilesLength;s++)if(e.projectiles[s].timeToLive-=t,e.projectiles[s].timeToLive<=0)n?n.push(s):n=[s];else{e.projectiles[s].x+=t*e.projectiles[s].velocityX,e.projectiles[s].y+=t*e.projectiles[s].velocityY;let a=e.projectiles[s];for(let t=0,i=e.agents.length;t<i;t++)for(let i=0,r=e.agentsLength[t];i<r;i++){if(a.team===t)continue;let r=e.agents[t][i];(r.x-a.x)*(r.x-a.x)+(r.y-a.y)*(r.y-a.y)<(r.collideRadius+a.collideRadius)*(r.collideRadius+a.collideRadius)&&(r.health-=a.damage,r.health=Math.max(0,r.health),n?n.push(s):n=[s])}}if(n){n=n.sort(this._sortNumber),console.log(n);for(let t=0;t<n.length;t++)this._removeProjectile(e,n[t])}}_sortNumber(e,t){return t-e}_removeProjectile(e,t){e.projectiles[t].inUse=!1;let n=e.projectiles[t];e.projectilesLength--,e.projectiles[t]=e.projectiles[e.projectilesLength],e.projectiles[e.projectilesLength]=n}_updateAgent(e,t,n,s,a){let i=!1,r=!1,l=s.x+s.velocityX*n;(l+s.collideRadius>=a.map.length||l-s.collideRadius<0)&&(i=!0);let o=s.y+s.velocityY*n;(o+s.collideRadius>=a.map[0].length||o-s.collideRadius<0)&&(r=!0),i||(s.velocityX>0?a.map[Math.floor(l+s.collideRadius)][Math.floor(o)]!==v.Floor&&(i=!0):s.velocityX<0&&a.map[Math.floor(l-s.collideRadius)][Math.floor(o)]!==v.Floor&&(i=!0)),r||(s.velocityY>0?a.map[Math.floor(l)][Math.floor(o+s.collideRadius)]!==v.Floor&&(r=!0):s.velocityY<0&&a.map[Math.floor(l)][Math.floor(o-s.collideRadius)]!==v.Floor&&(r=!0)),i||(s.x=l),r||(s.y=o),s.velocityX=0,s.velocityY=0}goalTest(e){for(let t=0;t<e.agentsLength.length;t++)e.agentsLength[t];return!1}}class S extends r{constructor(e,t,n,s){super(e,t,n),this.agentID=s}}class A{constructor(e){this._allActions=[];for(let e in y)isNaN(Number(e))||this._allActions.push[e];this._scenarioData=e}setClient(e){this._currentClient=e}setTeam(e){this._currentTeam=e}getCommand(e,t,n){t=t||0,n=n||this._currentTeam;let s=new S(e,this._currentClient,n,t);if(e===y.SpawnProjectile){if(this._scenarioData.projectilesLength>=this._scenarioData.projectiles.length-1)return null;let e=this._scenarioData.projectiles[this._scenarioData.projectilesLength];this._scenarioData.projectilesLength++,e.x=this._scenarioData.agents[n][t].x,e.y=this._scenarioData.agents[n][t].y,e.team=n,e.timeToLive=5,e.collideRadius=.1,e.damage=1,s.arg=e}return s}getCommandList(){return this._allActions}}class j extends g{constructor(e){let t=new w;t.load(e);let n=new f(t.clients(),new A(t));super(new x,t,n)}create(){super.create(),console.log("Created Fuseblade scenario with:"),console.log("a map of",this.data.map.length,"by",this.data.map[0].length),console.log(this.data.clients(),"clients"),console.log(this.data.teams.length,"teams"),console.log(this.data.agentsLength.reduce((e,t,n)=>e+t),"agents, assigned as follows:",...this.data.agentsLength)}update(e){for(let e=0;e<this.data.teams.length;e++)this.data.teams[e].isPlaying||this.clients.setObserver(e,!0);super.update(e)}}class L extends h{run(){return!!this.scenario.ready&&(this.scenario.created||this.scenario.create(),!0)}update(e){this.scenario.update(e)}connectLocalClient(e){return this.scenario.addClient(e)}}class O{constructor(e,t){this.key=e,this.value=t}}class D{constructor(){this.entries=[]}get length(){return this.entries.length}push(e,t){this.entries.push(new O(e,t))}delete(e,t){let n=[];this.entries.forEach(s=>{s.key!==e?n.push(s):t&&s.value!==t&&n.push(s)}),this.entries=n}deleteValue(e){let t=[];this.entries.forEach(n=>{n.value!==e&&t.push(n)}),this.entries=t}clear(){this.entries=[]}forEach(e){this.entries.forEach(e)}}class T{constructor(){this._callbacks=new D}call(...e){for(let t=0,n=this._callbacks.entries.length;t<n;t++)this._callbacks.entries[t].value(...e)}push(e,t){return this._callbacks.push(t,e),this}unregister(e){this._callbacks.delete(e)}remove(e){this._callbacks.deleteValue(e)}removeAll(){this._callbacks.clear()}get length(){return this._callbacks.length}clone(){let e=new(0,Object.getPrototypeOf(this).constructor);for(let t=0,n=this._callbacks.entries.length;t<n;t++)e.push(this._callbacks.entries[t].value,this._callbacks.entries[t].key);return e}static link(e,t,n){e&&t&&e.push(t.call.bind(t),n)}}class I extends T{call(e){for(let t=0,n=this._callbacks.entries.length;t<n;t++)this._callbacks.entries[t].value(e)}push(e,t){return super.push(e,t)}}class F{constructor(){this.onCommandRecieved=new I}recieveCommand(e){this.onCommandRecieved.call(e)}}class P{create(e,t,n){this._gameModel=n}update(e,t){let n=this._gameModel.stateActionMapping(e);if(n.length>0){let e=Math.round(Math.random()*n.length-1);return t.getCommand(n[e])}return null}scenarioEnded(e){}}n.d(t,"Command",(function(){return r})),n.d(t,"GameModel",(function(){return s})),n.d(t,"LocalPlayServer",(function(){return L})),n.d(t,"NodeServer",(function(){return d})),n.d(t,"Scenario",(function(){return u})),n.d(t,"AIClientConnection",(function(){return c})),n.d(t,"ClientConnection",(function(){return l})),n.d(t,"ClientController",(function(){return f})),n.d(t,"LocalServerConnection",(function(){return F})),n.d(t,"RandomAIClient",(function(){return P})),n.d(t,"FPScenario",(function(){return M})),n.d(t,"FBScenario",(function(){return j})),t.default=class{createFusebladeScenario(e){return new j(e)}createFarmerPuzzleScenario(){return new M}}}])},"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("GamesAIScenarioFactory",[],t):"object"==typeof exports?exports.GamesAIScenarioFactory=t():e.GamesAIScenarioFactory=t();