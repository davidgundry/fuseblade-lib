var e,t;e=window,t=function(){return function(e){var t={};function s(n){if(t[n])return t[n].exports;var a=t[n]={i:n,l:!1,exports:{}};return e[n].call(a.exports,a,a.exports,s),a.l=!0,a.exports}return s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)s.d(n,a,function(t){return e[t]}.bind(null,a));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=0)}([function(e,t,s){"use strict";s.r(t);class n{}class a extends n{}class i extends n{}class r{constructor(e,t,s){this.commandType=e,this.clientID=t,this.teamID=s}}class l{constructor(e,t){this._isObserver=!1,this.clientID=e,this.teamID=t}get isObserver(){return this._isObserver}set isObserver(e){this._isObserver=e}}class o extends l{constructor(e,t,s){super(e,t),this._commandsBuffer=[],this._local=s,s.clientID=e,s.onCommandRecieved.push(this.recieveCommand.bind(this))}createScenario(e,t){}sendDataUpdate(e){}grabCommands(e,t){let s=this._commandsBuffer;return this._commandsBuffer=[],s}recieveCommand(e){e.clientID=this.clientID,e.teamID=this.teamID,this._commandsBuffer.push(e)}}class c extends l{constructor(e,t,s){super(e,t),this._ai=s}createScenario(e,t){this._data=e,this._ai.create(this.clientID,this.teamID,t,e)}sendDataUpdate(e){this._data=e}grabCommands(e,t){return e.setClient(this.clientID),e.setTeam(this.teamID),this._ai.update(this._data,e,t)}}class h{loadScenario(e){this.scenario=e,this.scenario.ready&&this.scenario.create()}}class d extends h{constructor(){super(...arguments),this._ticks=0,this._maxTicks=1e3,this._delta=1/60}run(){if(!this.scenario.ready)throw new Error("Cannot run server as scenario is not ready");for(this.scenario.created||this.scenario.create(),console.log("Running scenario:"),console.log("for",this._maxTicks,"updates"),console.log("with a",this._delta,"s timestep");!this.scenario.ended&&this._ticks<this._maxTicks;)this.scenario.update(this._delta),this._ticks++;return console.log("Simulation completed after",this._ticks,"updates (",this._maxTicks*this._delta,"seconds simulated)"),console.log("Game over state was "+(this.scenario.ended?"":"not ")+"found"),!0}}class m{constructor(e,t,s){this._created=!1,this._gameModel=e,this._data=t,this._clients=s}get ended(){return this._ended}get ready(){return 0===this._clients.remainingSlots}get created(){return this._created}get clients(){return this._clients}get gameModel(){return this._gameModel}get data(){return this._data}create(){this.clients.createScenario(this._data,this._gameModel),this._created=!0}load(e){this._data.load(e)}getSaveData(){return this._data.save()}addClient(e){return this._clients.addClient(e)}addAITeam(e){this._clients.addClient(new c(this._clients.nextClient,this._clients.nextTeam,e))}addLocalClient(e){return this._clients.addClient(new o(this._clients.nextClient,this._clients.nextTeam,e))}runHeadless(){let e=new d;return e.loadScenario(this),!!e.run()}}class u extends m{update(){this.ended||(this.gameModel.applyCommands(this.data,this.clients.getCommandsOfClient(this.data.getCurrentPlayer(),1)),this.gameModel.goalTest(this.data)&&(this._ended=!0),this.data.moveToNextPlayer(),this.clients.sendDataUpdate(this.data))}}class g extends m{update(e){if(!this.ended){let t=this.clients.getCommands(e);this.gameModel.applyCommands(this.data,t,e),this.gameModel.goalTest(this.data)&&(this._ended=!0),this.clients.sendDataUpdate(this.data)}}}class f{constructor(e,t){this._clients=[],this._clientsCount=0,this._clients=new Array(e),this.commandFactory=t}get clientsCount(){return this._clientsCount}get maxClients(){return this._clients.length}get remainingSlots(){return this._clients.length-this._clientsCount}get nextClient(){let e=0;for(let t=0;t<this._clients.length;t++)this._clients[t]&&this._clients[t].clientID===e&&e++;return e}get nextTeam(){let e=0;for(let t=0;t<this._clients.length;t++)this._clients[t]&&this._clients[t].teamID===e&&e++;return e}addClient(e){for(let t=0;t<this._clientsCount;t++)if(this._clients[t].clientID===e.clientID)return!1;return this._clientsCount!==this._clients.length&&(this._clients[this._clientsCount]=e,this._clientsCount++,!0)}setObserver(e,t){this._clients[e].isObserver=t}createScenario(e,t){for(let s=0,n=this._clientsCount;s<n;s++)this._clients[s].createScenario(e,t)}sendDataUpdate(e,t){for(let t=0,s=this._clientsCount;t<s;t++)this._clients[t].sendDataUpdate(e)}getCommands(e){let t=[];for(let s=0,n=this._clientsCount;s<n;s++)this._clients[s].isObserver||(t=t.concat(this._clients[s].grabCommands(this.commandFactory,e)));return t}getCommandsOfClient(e,t){if(!this._clients[e].isObserver)return this._clients[e].grabCommands(this.commandFactory,t)}}var p,_,v,y;!function(e){e[e.Wolf=0]="Wolf",e[e.Sheep=1]="Sheep",e[e.Cabbage=2]="Cabbage"}(p||(p={})),function(e){e[e.MoveWolf=0]="MoveWolf",e[e.MoveCabbage=1]="MoveCabbage",e[e.MoveSheep=2]="MoveSheep",e[e.MoveFarmer=3]="MoveFarmer"}(_||(_={}));class k{load(e){this.leftBank=e.leftBank.slice(),this.rightBank=e.rightBank.slice(),this.farmerOnLeftBank=e.farmerOnLeftBank}cloneFrom(e){this.leftBank=e.leftBank.slice(),this.rightBank=e.rightBank.slice(),this.farmerOnLeftBank=e.farmerOnLeftBank}clients(){return 1}save(){return{leftBank:this.leftBank,rightBank:this.rightBank,farmerOnLeftBank:this.farmerOnLeftBank}}equals(e){if(this.leftBank.length!==e.leftBank.length)return!1;if(this.farmerOnLeftBank!==e.farmerOnLeftBank)return!1;for(let t=0,s=this.leftBank.length;t<s;t++){let s=!1;for(let n=0,a=e.leftBank.length;n<a;n++)if(this.leftBank[t]===e.leftBank[n]){s=!0;break}if(!s)return!1}return!0}getCurrentPlayer(){return 0}moveToNextPlayer(){}}class b extends a{stateActionMapping(e){if(this._checkIfFailureState(e))return[];let t=e.farmerOnLeftBank?e.leftBank:e.rightBank,s=new Array(t.length+1);s[s.length-1]=_.MoveFarmer;for(let e=0,n=t.length;e<n;e++)t[e]===p.Cabbage?s[e]=_.MoveCabbage:t[e]===p.Sheep?s[e]=_.MoveSheep:t[e]===p.Wolf&&(s[e]=_.MoveWolf);return s}applyCommands(e,t){if(!t)throw new Error("Command submitted was null");if(t instanceof Array)throw new Error("Must submit a single command as an action (not an array)");if(t.commandType===_.MoveFarmer)e.leftBank=e.leftBank,e.rightBank=e.rightBank,e.farmerOnLeftBank=!e.farmerOnLeftBank;else{let s;t.commandType===_.MoveCabbage?s=p.Cabbage:t.commandType===_.MoveSheep?s=p.Sheep:t.commandType===_.MoveWolf&&(s=p.Wolf);let n=[],a=[];for(let t=0,a=e.leftBank.length;t<a;t++)e.leftBank[t]!==s&&n.push(e.leftBank[t]);for(let t=0,n=e.rightBank.length;t<n;t++)e.rightBank[t]!==s&&a.push(e.rightBank[t]);e.farmerOnLeftBank?a.push(s):n.push(s),e.leftBank=n,e.rightBank=a,e.farmerOnLeftBank=!e.farmerOnLeftBank}}goalTest(e){return!!this._checkIfFailureState(e)||0===e.leftBank.length}heuristic(e){return 1e3*e.leftBank.length}_checkIfFailureState(e){if(e.farmerOnLeftBank){if(-1!==e.rightBank.indexOf(p.Wolf)&&-1!==e.rightBank.indexOf(p.Sheep)||-1!==e.rightBank.indexOf(p.Cabbage)&&-1!==e.rightBank.indexOf(p.Sheep))return!0}else if(-1!==e.leftBank.indexOf(p.Wolf)&&-1!==e.leftBank.indexOf(p.Sheep)||-1!==e.leftBank.indexOf(p.Cabbage)&&-1!==e.leftBank.indexOf(p.Sheep))return!0;return!1}}class C{setClient(e){}setTeam(e){}getCommandList(){return[_.MoveCabbage,_.MoveFarmer,_.MoveWolf,_.MoveSheep]}getCommand(e){return new r(e,0,0)}}class x extends u{constructor(){let e=new k;e.load({leftBank:[p.Sheep,p.Wolf,p.Cabbage],rightBank:[],farmerOnLeftBank:!0}),super(new b,e,new f(1,new C))}}class A{constructor(){this.inUse=!1,this.y=1/0}}class M{constructor(){this.inUse=!1}}!function(e){e[e.Floor=0]="Floor",e[e.Void=1]="Void"}(v||(v={}));class B{cloneFrom(e){}clients(){return this.teams.length}load(e){if(this.maxAgentsPerTeam=e.maxAgentsPerTeam,this.maxProjectiles=e.maxProjectiles,!e.map){e.map=new Array(20);for(let t=0;t<e.map.length;t++){e.map[t]=new Array(20);for(let s=0;s<e.map[t].length;s++)e.map[t][s]=0}}this.teams=e.teams,this.teams.forEach((e,t)=>{if(e.isPlaying&&0===e.currentAgents)throw new Error("Save Data Error: A team with 0 agents must have an isPlaying value of false");if(e.killCount.length!==this.teams.length)throw new Error("Save Data Error: Incorrect length of kill count array ("+e.killCount.length+") for team "+t+" it should be length "+this.teams.length)});for(let e=0,t=this.teams.length;e<t;e++)this.teams[e].currentAgents=this.teams[e].agents.length,this.teams[e].agents.length=this.maxAgentsPerTeam;this.sortedAgents=new Array(this.maxAgentsPerTeam*this.teams.length);for(let e=0;e<this.teams.length;e++)for(let t=this.teams[e].currentAgents;t<this.maxAgentsPerTeam;t++)this.teams[e].agents[t]=new A;for(let e=0,t=this.teams.length;e<t;e++)for(let t=0,s=this.teams[e].agents.length;t<s;t++)this.teams[e].agents[t]?this.sortedAgents[e*this.teams[e].agents.length+t]=this.teams[e].agents[t]:this.sortedAgents[e*this.teams[e].agents.length+t]=new A;this.sortAgents(),this.map=new Array(e.map.length);for(let t=0,s=this.map.length;t<s;t++){this.map[t]=new Array(e.map[t].length);for(let s=0,n=this.map.length;s<n;s++)this.map[t][s]=e.map[s][t]}this.projectiles=new Array(this.maxProjectiles);for(let e=0;e<this.projectiles.length;e++)this.projectiles[e]=new M;this.projectilesLength=0}save(){let e=new Array(this.teams.length);for(let t=0,s=this.teams.length;t<s;t++)e[t]=this.teams[t];let t=new Array(this.map.length);for(let e=0,s=this.map.length;e<s;e++){t[e]=new Array(this.map[e].length);for(let s=0,n=this.map.length;s<n;s++)t[e][s]=this.map[e][s]}return{maxProjectiles:this.maxProjectiles,maxAgentsPerTeam:this.maxAgentsPerTeam,teams:e,map:t}}sortAgents(){let e=this.sortedAgents;for(let t=2;t<e.length;t++)for(let s=t;s>1&&e[s].y<e[s-1].y;s--){let t=e[s];e[s]=e[s-1],e[s-1]=t}}}!function(e){e[e.AgentMoveNorth=0]="AgentMoveNorth",e[e.AgentMoveSouth=1]="AgentMoveSouth",e[e.AgentMoveEast=2]="AgentMoveEast",e[e.AgentMoveWest=3]="AgentMoveWest",e[e.SpawnProjectile=4]="SpawnProjectile"}(y||(y={}));class w extends i{constructor(){super(),this._allActions=[];for(let e in y)isNaN(Number(e))||this._allActions.push(parseInt(e))}stateActionMapping(e){return this._allActions}applyCommands(e,t,s){for(let n=0,a=t.length;n<a;n++)if(t[n]){e.teams[t[n].teamID].movesMade++;let a=e.teams[t[n].teamID].agents[t[n].agentID];if(!a)throw new Error("Command returned for agent that does not exist. Team "+t[n].teamID+", agent: "+t[n].agentID);a.inUse&&this._agentActions(t[n],t[n].teamID,t[n].agentID,s,a,e)}this._doStateUpdate(e,s)}_agentActions(e,t,s,n,a,i){if(e.commandType===y.AgentMoveNorth)a.velocityY=Math.max(a.velocityY-a.speed,-a.speed);else if(e.commandType===y.AgentMoveSouth)a.velocityY=Math.min(a.velocityY+a.speed,a.speed);else if(e.commandType===y.AgentMoveEast)a.velocityX=Math.min(a.velocityX+a.speed,a.speed);else if(e.commandType===y.AgentMoveWest)a.velocityX=Math.max(a.velocityX-a.speed,-a.speed);else if(e.commandType===y.SpawnProjectile)if(e.arg instanceof M)e.arg.inUse=!0;else if(i.projectilesLength<i.projectiles.length-1){let e=5*Math.random()-2.5,s=5*Math.random()-2.5,n=i.projectiles[i.projectilesLength];i.projectilesLength++,n.x=a.x,n.y=a.y,n.velocityX=a.velocityX+e,n.velocityY=a.velocityY+s,n.damage=1,n.team=t,n.timeToLive=5,n.collideRadius=.1,n.inUse=!0}}_doStateUpdate(e,t){for(let s=0,n=e.sortedAgents.length;s<n;s++)!1!==e.sortedAgents[s].inUse&&this._updateAgent(t,e.sortedAgents[s],e);for(let t=0;t<e.teams.length;t++)0===e.teams[t].currentAgents&&(e.teams[t].isPlaying=!1);let s;for(let n=0;n<e.projectilesLength;n++)if(e.projectiles[n].timeToLive-=t,e.projectiles[n].timeToLive<=0)s?s.push(n):s=[n];else{e.projectiles[n].x+=t*e.projectiles[n].velocityX,e.projectiles[n].y+=t*e.projectiles[n].velocityY;let a=e.projectiles[n];for(let t=0,i=e.sortedAgents.length;t<i;t++){let i=e.sortedAgents[t];if(!1!==i.inUse&&a.team!==i.team){if(i.y-i.collideRadius>a.y+a.collideRadius)break;if((i.x-a.x)*(i.x-a.x)+(i.y-a.y)*(i.y-a.y)<(i.collideRadius+a.collideRadius)*(i.collideRadius+a.collideRadius)){i.health-=a.damage,i.health=Math.max(0,i.health),0===i.health&&(i.y=1/0,i.inUse=!1,e.teams[i.team].currentAgents--),s?s.push(n):s=[n];break}}}}if(s){s=s.sort(this._sortNumber);for(let t=0;t<s.length;t++)this._removeProjectile(e,s[t])}e.sortAgents()}_sortNumber(e,t){return t-e}_removeProjectile(e,t){e.projectiles[t].inUse=!1;let s=e.projectiles[t];e.projectilesLength--,e.projectiles[t]=e.projectiles[e.projectilesLength],e.projectiles[e.projectilesLength]=s}_updateAgent(e,t,s){let n=!1,a=!1,i=t.x+t.velocityX*e;(i+t.collideRadius>=s.map.length||i-t.collideRadius<0)&&(n=!0);let r=t.y+t.velocityY*e;(r+t.collideRadius>=s.map[0].length||r-t.collideRadius<0)&&(a=!0),n||(t.velocityX>0?s.map[Math.floor(i+t.collideRadius)][Math.floor(r)]!==v.Floor&&(n=!0):t.velocityX<0&&s.map[Math.floor(i-t.collideRadius)][Math.floor(r)]!==v.Floor&&(n=!0)),a||(t.velocityY>0?s.map[Math.floor(i)][Math.floor(r+t.collideRadius)]!==v.Floor&&(a=!0):t.velocityY<0&&s.map[Math.floor(i)][Math.floor(r-t.collideRadius)]!==v.Floor&&(a=!0)),n||(t.x=i),a||(t.y=r),t.velocityX=0,t.velocityY=0}goalTest(e){for(let t=0;t<e.teams.length;t++)e.teams[t].currentAgents;return!1}}class S extends r{constructor(e,t,s,n){super(e,t,s),this.agentID=n}}class j{constructor(e){this._allActions=[];for(let e in y)isNaN(Number(e))||this._allActions.push[e];this._scenarioData=e}setClient(e){this._currentClient=e}setTeam(e){this._currentTeam=e}getCommand(e,t,s){if(t=t||0,s=s||this._currentTeam,!this._scenarioData.teams[s].agents[t].inUse)throw new Error("Getting command for agent which is not in use");let n=new S(e,this._currentClient,s,t);if(e===y.SpawnProjectile){if(this._scenarioData.projectilesLength>=this._scenarioData.projectiles.length-1)return null;let e=this._scenarioData.projectiles[this._scenarioData.projectilesLength];this._scenarioData.projectilesLength++,e.x=this._scenarioData.teams[s].agents[t].x,e.y=this._scenarioData.teams[s].agents[t].y,e.team=s,e.timeToLive=5,e.collideRadius=.1,e.damage=1,n.arg=e}return n}getCommandList(){return this._allActions}}class O extends g{constructor(e){let t=new B;t.load(e);let s=new f(t.clients(),new j(t));super(new w,t,s)}create(){super.create(),console.log("Created Fuseblade scenario with:"),console.log("a map of",this.data.map.length,"by",this.data.map[0].length),console.log(this.data.clients(),"clients"),console.log(this.data.teams.length,"teams")}update(e){for(let e=0;e<this.data.teams.length;e++)this.data.teams[e].isPlaying||this.clients.setObserver(e,!0);super.update(e)}}class D extends h{run(){return!!this.scenario.ready&&(this.scenario.created||this.scenario.create(),!0)}update(e){this.scenario.update(e)}connectLocalClient(e){return this.scenario.addClient(e)}}class T{constructor(e,t){this.key=e,this.value=t}}class L{constructor(){this.entries=[]}get length(){return this.entries.length}push(e,t){this.entries.push(new T(e,t))}delete(e,t){let s=[];this.entries.forEach(n=>{n.key!==e?s.push(n):t&&n.value!==t&&s.push(n)}),this.entries=s}deleteValue(e){let t=[];this.entries.forEach(s=>{s.value!==e&&t.push(s)}),this.entries=t}clear(){this.entries=[]}forEach(e){this.entries.forEach(e)}}class I{constructor(){this._callbacks=new L}call(...e){for(let t=0,s=this._callbacks.entries.length;t<s;t++)this._callbacks.entries[t].value(...e)}push(e,t){return this._callbacks.push(t,e),this}unregister(e){this._callbacks.delete(e)}remove(e){this._callbacks.deleteValue(e)}removeAll(){this._callbacks.clear()}get length(){return this._callbacks.length}clone(){let e=new(0,Object.getPrototypeOf(this).constructor);for(let t=0,s=this._callbacks.entries.length;t<s;t++)e.push(this._callbacks.entries[t].value,this._callbacks.entries[t].key);return e}static link(e,t,s){e&&t&&e.push(t.call.bind(t),s)}}class P extends I{call(e){for(let t=0,s=this._callbacks.entries.length;t<s;t++)this._callbacks.entries[t].value(e)}push(e,t){return super.push(e,t)}}class F{constructor(){this.onCommandRecieved=new P}recieveCommand(e){this.onCommandRecieved.call(e)}}class R{create(e,t,s){this._gameModel=s}update(e,t){let s=this._gameModel.stateActionMapping(e);if(s.length>0){let e=Math.round(Math.random()*s.length-1);return t.getCommand(s[e])}return null}scenarioEnded(e){}}s.d(t,"Command",(function(){return r})),s.d(t,"GameModel",(function(){return n})),s.d(t,"LocalPlayServer",(function(){return D})),s.d(t,"NodeServer",(function(){return d})),s.d(t,"Scenario",(function(){return m})),s.d(t,"AIClientConnection",(function(){return c})),s.d(t,"ClientConnection",(function(){return l})),s.d(t,"ClientController",(function(){return f})),s.d(t,"LocalServerConnection",(function(){return F})),s.d(t,"RandomAIClient",(function(){return R})),s.d(t,"FPScenario",(function(){return x})),s.d(t,"FBScenario",(function(){return O})),t.default=class{createFusebladeScenario(e){return new O(e)}createFarmerPuzzleScenario(){return new x}}}])},"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("GamesAIScenarioFactory",[],t):"object"==typeof exports?exports.GamesAIScenarioFactory=t():e.GamesAIScenarioFactory=t();